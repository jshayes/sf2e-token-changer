<section class="sf2e-token-state-editor" data-part="main">
  <div class="sf2e-token-state-editor">
    <header class="sf2e-token-state-editor__header">
      <p class="notes">
        Build structured token state config JSON. Runtime wiring can continue to use legacy rules until migrated.
      </p>
    </header>

    <section class="sf2e-token-state-editor__section">
      <h3>Default</h3>
      <div class="form-group">
        <label>Image</label>
        <div class="form-fields">
          <input
            type="text"
            value="{{config.default.image}}"
            data-path="default.image"
            placeholder="icons/svg/mystery-man.svg"
          />
          <button type="button" data-action="pick-file" data-path="default.image" data-picker-type="image">Browse</button>
        </div>
      </div>
      <div class="form-group">
        <label>Scale</label>
        <div class="form-fields">
          <input type="range" min="0.1" max="3" step="0.05" value="{{config.default.scale}}" data-path="default.scale" />
          <input type="number" min="0.1" max="3" step="0.05" value="{{config.default.scale}}" data-path="default.scale" />
        </div>
      </div>
      <div class="form-group">
        <label>Explicit Binding</label>
        <div class="form-fields">
          <input type="checkbox" {{#if config.default.bindExplicitly}}checked{{/if}} data-path="default.bindExplicitly" />
        </div>
        <p class="notes">When enabled, the selected default image/scale is treated as the baseline state explicitly.</p>
      </div>
    </section>

    <section class="sf2e-token-state-editor__section">
    <div class="sf2e-token-state-editor__section-header">
      <h3>Token States</h3>
      <button type="button" data-action="add-token-state">Add State</button>
    </div>
    <p class="notes">Rows are evaluated top to bottom. Drag to reorder priority.</p>
    <div class="sf2e-token-state-editor__row-header sf2e-token-state-editor__row-header--token">
      <span>Row</span>
      <span>Type</span>
      <span>Condition</span>
      <span>Image</span>
      <span>Scale</span>
      <span>Actions</span>
    </div>

    <div class="sf2e-token-state-editor__rows" data-list="tokenStates">
        {{#each tokenStates}}
        <article class="sf2e-token-state-editor__row" data-list="tokenStates" data-index="{{index}}">
          <div class="sf2e-token-state-editor__row-toolbar">
            <button type="button" draggable="true" data-action="drag-handle" title="Drag priority">☰</button>
          </div>

          <div class="form-group sf2e-token-state-editor__cell sf2e-token-state-editor__cell--type">
            <label>State Type</label>
            <div class="form-fields">
              <select data-action="set-condition-type" data-list="tokenStates" data-index="{{index}}">
                {{#each conditionTypeOptions}}
                    <option value="{{value}}" {{#if selected}}selected{{/if}}>{{label}}</option>
                  {{/each}}
              </select>
            </div>
          </div>

          <div class="sf2e-token-state-editor__cell sf2e-token-state-editor__cell--condition">
          {{#if isHpPercent}}
            <div class="form-group">
              <label>Operator</label>
              <div class="form-fields">
                <select data-action="set-condition-field" data-list="tokenStates" data-index="{{index}}" data-field="operator">
                    {{#each operatorOptions}}
                      <option value="{{value}}" {{#if selected}}selected{{/if}}>{{label}}</option>
                    {{/each}}
                  </select>
                </div>
              </div>
              <div class="form-group">
                <label>HP Percent</label>
                <div class="form-fields">
                  <input type="number" min="0" max="1" step="0.01" value="{{conditionValue}}" data-action="set-condition-field" data-list="tokenStates" data-index="{{index}}" data-field="value" />
              </div>
            </div>
          {{/if}}
          {{#if isHpValue}}
            <div class="form-group">
              <label>Operator</label>
              <div class="form-fields">
                <select data-action="set-condition-field" data-list="tokenStates" data-index="{{index}}" data-field="operator">
                    {{#each operatorOptions}}
                      <option value="{{value}}" {{#if selected}}selected{{/if}}>{{label}}</option>
                    {{/each}}
                  </select>
                </div>
              </div>
              <div class="form-group">
                <label>HP Value</label>
                <div class="form-fields">
                  <input type="number" step="1" value="{{conditionValue}}" data-action="set-condition-field" data-list="tokenStates" data-index="{{index}}" data-field="value" />
              </div>
            </div>
          {{/if}}
          {{#if isInCombat}}
            <div class="form-group">
              <label>In Combat</label>
              <div class="form-fields">
                <select data-action="set-condition-field" data-list="tokenStates" data-index="{{index}}" data-field="value">
                    <option value="true" {{#if inCombatValueTrue}}selected{{/if}}>Yes</option>
                    <option value="false" {{#if inCombatValueFalse}}selected{{/if}}>No</option>
                  </select>
              </div>
            </div>
          {{/if}}
          {{#if isStatusEffect}}
            <div class="form-group">
              <label>Operator</label>
              <div class="form-fields">
                <select data-action="set-condition-field" data-list="tokenStates" data-index="{{index}}" data-field="operator">
                    <option value="any-of" {{#if statusOperatorAny}}selected{{/if}}>Any Of</option>
                    <option value="all-of" {{#if statusOperatorAll}}selected{{/if}}>All Of</option>
                  </select>
                </div>
              </div>
              <div class="form-group">
                <label>Status Slugs</label>
                <div class="form-fields">
                <input type="text" value="{{statusValueText}}" placeholder="off-guard, frightened" data-action="set-condition-field" data-list="tokenStates" data-index="{{index}}" data-field="valueText" />
              </div>
            </div>
          {{/if}}
          </div>

          <div class="form-group sf2e-token-state-editor__cell sf2e-token-state-editor__cell--asset">
            <label>Image</label>
            <div class="form-fields">
              <input type="text" value="{{row.image}}" data-action="set-row-field" data-list="tokenStates" data-index="{{index}}" data-field="image" />
                <button type="button" data-action="pick-row-file" data-list="tokenStates" data-index="{{index}}" data-field="image" data-picker-type="image">Browse</button>
            </div>
          </div>

          <div class="form-group sf2e-token-state-editor__cell sf2e-token-state-editor__cell--value">
            <label>Scale</label>
            <div class="form-fields">
              <input type="range" min="0.1" max="3" step="0.05" value="{{row.scale}}" data-action="set-row-field" data-list="tokenStates" data-index="{{index}}" data-field="scale" />
              <input type="number" min="0.1" max="3" step="0.05" value="{{row.scale}}" data-action="set-row-field" data-list="tokenStates" data-index="{{index}}" data-field="scale" />
            </div>
          </div>

          <div class="sf2e-token-state-editor__cell sf2e-token-state-editor__cell--actions">
            <button type="button" data-action="remove-row" data-list="tokenStates" data-index="{{index}}">Remove</button>
          </div>
        </article>
      {{/each}}
    </div>
    </section>

    <section class="sf2e-token-state-editor__section">
    <div class="sf2e-token-state-editor__section-header">
      <h3>Sounds</h3>
      <button type="button" data-action="add-sound">Add Sound Trigger</button>
    </div>
    <p class="notes">Sounds are transition triggers and should fire once when entering a matching state.</p>
    <div class="sf2e-token-state-editor__row-header sf2e-token-state-editor__row-header--sound">
      <span>Row</span>
      <span>Type</span>
      <span>Condition</span>
      <span>Sound</span>
      <span>Volume</span>
      <span>Actions</span>
    </div>

    <div class="sf2e-token-state-editor__rows" data-list="sounds">
        {{#each sounds}}
        <article class="sf2e-token-state-editor__row" data-list="sounds" data-index="{{index}}">
          <div class="sf2e-token-state-editor__row-toolbar">
            <button type="button" draggable="true" data-action="drag-handle" title="Drag priority">☰</button>
            <strong>{{label}}</strong>
          </div>

          <div class="form-group sf2e-token-state-editor__cell sf2e-token-state-editor__cell--type">
            <label>Trigger Type</label>
            <div class="form-fields">
              <select data-action="set-condition-type" data-list="sounds" data-index="{{index}}">
                  {{#each conditionTypeOptions}}
                    <option value="{{value}}" {{#if selected}}selected{{/if}}>{{label}}</option>
                  {{/each}}
              </select>
            </div>
          </div>

          <div class="sf2e-token-state-editor__cell sf2e-token-state-editor__cell--condition">
          {{#if isHpPercent}}
            <div class="form-group">
              <label>Operator</label>
              <div class="form-fields">
                <select data-action="set-condition-field" data-list="sounds" data-index="{{index}}" data-field="operator">
                    {{#each operatorOptions}}
                      <option value="{{value}}" {{#if selected}}selected{{/if}}>{{label}}</option>
                    {{/each}}
                  </select>
                </div>
              </div>
              <div class="form-group">
                <label>HP Percent</label>
                <div class="form-fields">
                  <input type="number" min="0" max="1" step="0.01" value="{{conditionValue}}" data-action="set-condition-field" data-list="sounds" data-index="{{index}}" data-field="value" />
              </div>
            </div>
          {{/if}}
          {{#if isHpValue}}
            <div class="form-group">
              <label>Operator</label>
              <div class="form-fields">
                <select data-action="set-condition-field" data-list="sounds" data-index="{{index}}" data-field="operator">
                    {{#each operatorOptions}}
                      <option value="{{value}}" {{#if selected}}selected{{/if}}>{{label}}</option>
                    {{/each}}
                  </select>
                </div>
              </div>
              <div class="form-group">
                <label>HP Value</label>
                <div class="form-fields">
                  <input type="number" step="1" value="{{conditionValue}}" data-action="set-condition-field" data-list="sounds" data-index="{{index}}" data-field="value" />
              </div>
            </div>
          {{/if}}
          {{#if isInCombat}}
            <div class="form-group">
              <label>In Combat</label>
              <div class="form-fields">
                <select data-action="set-condition-field" data-list="sounds" data-index="{{index}}" data-field="value">
                    <option value="true" {{#if inCombatValueTrue}}selected{{/if}}>Yes</option>
                    <option value="false" {{#if inCombatValueFalse}}selected{{/if}}>No</option>
                  </select>
              </div>
            </div>
          {{/if}}
          {{#if isStatusEffect}}
            <div class="form-group">
              <label>Operator</label>
              <div class="form-fields">
                <select data-action="set-condition-field" data-list="sounds" data-index="{{index}}" data-field="operator">
                    <option value="any-of" {{#if statusOperatorAny}}selected{{/if}}>Any Of</option>
                    <option value="all-of" {{#if statusOperatorAll}}selected{{/if}}>All Of</option>
                  </select>
                </div>
              </div>
              <div class="form-group">
                <label>Status Slugs</label>
                <div class="form-fields">
                <input type="text" value="{{statusValueText}}" placeholder="off-guard, frightened" data-action="set-condition-field" data-list="sounds" data-index="{{index}}" data-field="valueText" />
              </div>
            </div>
          {{/if}}
          </div>

          <div class="form-group sf2e-token-state-editor__cell sf2e-token-state-editor__cell--asset">
            <label>Sound</label>
            <div class="form-fields">
              <input type="text" value="{{row.src}}" data-action="set-row-field" data-list="sounds" data-index="{{index}}" data-field="src" />
                <button type="button" data-action="pick-row-file" data-list="sounds" data-index="{{index}}" data-field="src" data-picker-type="audio">Browse</button>
            </div>
          </div>

          <div class="form-group sf2e-token-state-editor__cell sf2e-token-state-editor__cell--value">
            <label>Volume</label>
            <div class="form-fields">
              <input type="range" min="0" max="1" step="0.05" value="{{row.volume}}" data-action="set-row-field" data-list="sounds" data-index="{{index}}" data-field="volume" />
              <input type="number" min="0" max="1" step="0.05" value="{{row.volume}}" data-action="set-row-field" data-list="sounds" data-index="{{index}}" data-field="volume" />
            </div>
          </div>

          <div class="sf2e-token-state-editor__cell sf2e-token-state-editor__cell--actions">
            <button type="button" data-action="remove-row" data-list="sounds" data-index="{{index}}">Remove</button>
          </div>
        </article>
      {{/each}}
      </div>
    </section>

    <section class="sf2e-token-state-editor__section">
      <h3>JSON Preview</h3>
      <textarea rows="10" spellcheck="false" readonly>{{jsonPreview}}</textarea>
    </section>

    <footer class="sf2e-token-state-editor__footer">
      <button type="button" data-action="save-config">Apply To Token Config</button>
      <button type="button" data-action="close-editor">Close</button>
    </footer>
  </div>
</section>
